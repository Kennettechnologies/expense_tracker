{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<style>
  .chart-container {
    position: relative;
    height: 300px;
    margin-bottom: 2rem;
  }
  
  .stats-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
  }
  
  .stats-card:hover {
    transform: translateY(-5px);
  }
  
  .stats-card.income {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  }
  
  .stats-card.expense {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
  }
  
  .stats-card.balance {
    background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
    color: #333;
  }
  
  .stats-card.health {
    background: linear-gradient(135deg, #96fbc4 0%, #f9f047 100%);
    color: #333;
  }
  
  .stats-value {
    font-size: 2.5rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
  }
  
  .stats-label {
    font-size: 0.9rem;
    opacity: 0.9;
  }
  
  .stats-change {
    font-size: 0.8rem;
    margin-top: 0.5rem;
  }
  
  .change-positive {
    color: #28a745;
  }
  
  .change-negative {
    color: #dc3545;
  }
  
  .notification-item {
    border-left: 4px solid #007bff;
    padding: 1rem;
    margin-bottom: 0.5rem;
    background: #f8f9fa;
    border-radius: 0 8px 8px 0;
  }
  
  .notification-item.high {
    border-left-color: #dc3545;
  }
  
  .notification-item.medium {
    border-left-color: #ffc107;
  }
  
  .notification-item.low {
    border-left-color: #28a745;
  }
  
  .health-score-circle {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: bold;
    margin: 0 auto;
  }
  
  .score-excellent {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
  }
  
  .score-good {
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    color: white;
  }
  
  .score-fair {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    color: white;
  }
  
  .score-poor {
    background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
    color: #333;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row mb-4">
    <div class="col-12">
      <h1 class="h3 mb-3">Enhanced Dashboard</h1>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Basic Dashboard</a></li>
          <li class="breadcrumb-item active">Enhanced Dashboard</li>
        </ol>
      </nav>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="stats-card income">
        <div class="stats-value">${{ current_month_income|floatformat:0 }}</div>
        <div class="stats-label">Monthly Income</div>
        {% if income_change != 0 %}
        <div class="stats-change">
          <i class="fas fa-{% if income_change > 0 %}arrow-up change-positive{% else %}arrow-down change-negative{% endif %}"></i>
          {{ income_change|floatformat:1 }}% from last month
        </div>
        {% endif %}
      </div>
    </div>
    <div class="col-md-3">
      <div class="stats-card expense">
        <div class="stats-value">${{ current_month_expenses|floatformat:0 }}</div>
        <div class="stats-label">Monthly Expenses</div>
        {% if expense_change != 0 %}
        <div class="stats-change">
          <i class="fas fa-{% if expense_change > 0 %}arrow-up change-negative{% else %}arrow-down change-positive{% endif %}"></i>
          {{ expense_change|floatformat:1 }}% from last month
        </div>
        {% endif %}
      </div>
    </div>
    <div class="col-md-3">
      <div class="stats-card balance">
        <div class="stats-value">${{ total_balance|floatformat:0 }}</div>
        <div class="stats-label">Total Balance</div>
        <div class="stats-change">
          Net Savings: ${{ net_savings|floatformat:0 }}
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stats-card health">
        <div class="stats-value">{{ health_score.score }}/100</div>
        <div class="stats-label">Financial Health</div>
        <div class="stats-change">
          <a href="{% url 'financial_health' %}" class="text-dark">View Details</a>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Charts Column -->
    <div class="col-lg-8">
      <!-- Spending Trend Chart -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0">Daily Spending Trend (Last 30 Days)</h5>
        </div>
        <div class="card-body">
          <div class="chart-container">
            <canvas id="spendingTrendChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Category Breakdown Chart -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0">Spending by Category (This Month)</h5>
        </div>
        <div class="card-body">
          <div class="chart-container">
            <canvas id="categoryChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Budget Progress -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0">Budget Progress</h5>
        </div>
        <div class="card-body">
          {% for budget in budget_progress %}
          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <span class="fw-medium">{{ budget.name }}</span>
              <span class="text-muted">${{ budget.spent|floatformat:0 }} / ${{ budget.budget|floatformat:0 }}</span>
            </div>
            <div class="progress" style="height: 8px;">
              <div class="progress-bar bg-{{ budget.status }}" 
                   role="progressbar" 
                   style="width: {{ budget.progress }}%"
                   aria-valuenow="{{ budget.progress }}" 
                   aria-valuemin="0" 
                   aria-valuemax="100">
              </div>
            </div>
            <small class="text-muted">{{ budget.progress|floatformat:1 }}% used</small>
          </div>
          {% empty %}
          <p class="text-muted">No budgets set. <a href="{% url 'budget_create' %}">Create your first budget</a></p>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
      <!-- Financial Health Score -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0">Financial Health Score</h5>
        </div>
        <div class="card-body text-center">
          <div class="health-score-circle 
                      {% if health_score.score >= 80 %}score-excellent
                      {% elif health_score.score >= 60 %}score-good
                      {% elif health_score.score >= 40 %}score-fair
                      {% else %}score-poor{% endif %}">
            {{ health_score.score }}/100
          </div>
          <div class="mt-3">
            <small class="text-muted">
              {% if health_score.score >= 80 %}Excellent financial health!
              {% elif health_score.score >= 60 %}Good financial health
              {% elif health_score.score >= 40 %}Fair financial health
              {% else %}Needs improvement{% endif %}
            </small>
          </div>
          <div class="mt-2">
            <a href="{% url 'financial_health' %}" class="btn btn-sm btn-outline-primary">View Analysis</a>
          </div>
        </div>
      </div>

      <!-- Recent Notifications -->
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">Recent Notifications</h5>
          <a href="{% url 'notifications' %}" class="btn btn-sm btn-outline-primary">View All</a>
        </div>
        <div class="card-body">
          {% for notification in notifications %}
          <div class="notification-item {{ notification.priority }}">
            <div class="fw-medium">{{ notification.title }}</div>
            <div class="text-muted small">{{ notification.message|truncatewords:15 }}</div>
            <div class="text-muted small mt-1">{{ notification.created_at|timesince }} ago</div>
          </div>
          {% empty %}
          <p class="text-muted">No new notifications</p>
          {% endfor %}
        </div>
      </div>

      <!-- Savings Goals -->
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">Active Goals</h5>
          <a href="{% url 'goals' %}" class="btn btn-sm btn-outline-primary">View All</a>
        </div>
        <div class="card-body">
          {% for goal in goals %}
          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <span class="fw-medium">{{ goal.name }}</span>
              <span class="text-muted">${{ goal.current_amount|floatformat:0 }} / ${{ goal.target_amount|floatformat:0 }}</span>
            </div>
            <div class="progress" style="height: 6px;">
              <div class="progress-bar bg-success" 
                   role="progressbar" 
                   style="width: {{ goal.progress_percentage }}%"
                   aria-valuenow="{{ goal.progress_percentage }}" 
                   aria-valuemin="0" 
                   aria-valuemax="100">
              </div>
            </div>
            <small class="text-muted">{{ goal.progress_percentage|floatformat:1 }}% complete</small>
          </div>
          {% empty %}
          <p class="text-muted">No active goals. <a href="{% url 'goal_create' %}">Create your first goal</a></p>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Daily Spending Trend Chart
const spendingData = {{ daily_spending|safe }};
const spendingCtx = document.getElementById('spendingTrendChart').getContext('2d');
new Chart(spendingCtx, {
    type: 'line',
    data: {
        labels: spendingData.map(d => d.date),
        datasets: [{
            label: 'Daily Spending',
            data: spendingData.map(d => d.amount),
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return '$' + value.toFixed(0);
                    }
                }
            },
            x: {
                ticks: {
                    maxTicksLimit: 10
                }
            }
        }
    }
});

// Category Breakdown Chart
const categoryData = {{ category_data|safe }};
if (categoryData.length > 0) {
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    new Chart(categoryCtx, {
        type: 'doughnut',
        data: {
            labels: categoryData.map(d => d.category__name || 'Uncategorized'),
            datasets: [{
                data: categoryData.map(d => d.total),
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                    '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF',
                    '#4BC0C0', '#FF6384'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.label + ': $' + context.parsed.toFixed(2);
                        }
                    }
                }
            }
        }
    });
} else {
    document.getElementById('categoryChart').parentElement.innerHTML = 
        '<p class="text-muted text-center">No expense data for this month</p>';
}
</script>
{% endblock %}
